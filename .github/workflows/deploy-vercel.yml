name: "[agio-docs] Deploy to Vercel"

on:
  push:
    branches:
      - main

env:
  VERCEL_PROJECT_ID: prj_D1DR6ucEFBjby00L7gjgQG9dgRl2
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Setup Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.6.0 --activate
          yarn --version

      - name: Cache Yarn (Berry global cache)
        uses: actions/cache@v4
        with:
          path: |
            ~/.yarn/berry/cache
            ~/.cache/yarn
          key: ${{ runner.os }}-yarn4-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn4-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run tests
        run: yarn test

      - name: Build VitePress site
        run: yarn build

      - name: Prepare Vercel Output
        run: |
          mkdir -p .vercel/output/static
          cp -r docs/.vitepress/dist/* .vercel/output/static/

          cat <<'EOF' > .vercel/output/config.json
          {
            "version": 3,
            "routes": [
              {
                "src": "/assets/.*\\.[a-f0-9]+\\.(js|css|woff2?)$",
                "headers": { "Cache-Control": "public, max-age=31536000, immutable" }
              },
              { "handle": "filesystem" },
              {
                "src": "/.*",
                "dest": "/index.html",
                "headers": { "Cache-Control": "no-cache, max-age=0, must-revalidate" }
              }
            ]
          }
          EOF

      - name: Deploy to Vercel
        id: deploy
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID }}
        run: |
          DEPLOYMENT_URL=$(npx vercel@latest deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_SCOPE }})
          echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

      - name: Assign Custom Domain
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ env.VERCEL_PROJECT_ID }}
        run: |
          echo "Assigning domain docs.agiodigital.com to deployment ${{ steps.deploy.outputs.deployment-url }}"
          npx vercel@latest alias ${{ steps.deploy.outputs.deployment-url }} docs.agiodigital.com --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_SCOPE }}

      - name: Action Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "Deployment URL: ${{ steps.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "Custom Domain: https://docs.agiodigital.com" >> $GITHUB_STEP_SUMMARY
